<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>EOBots</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --nav-h: 80px; }
    html,body{scroll-behavior:smooth; scroll-padding-top: var(--nav-h);}

    /* Sections ALWAYS full screen */
    .section{
      min-height:100svh;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      scroll-margin-top:var(--nav-h);
    }

    /* Animated spacer (between sections) */
    .spacer {
      position: relative;
      width: 100%;
      height: 12svh;               /* big, obvious divider */
      min-height: 96px;
      overflow: hidden;
      border-top: 1px solid rgba(239,68,68,.35);
      border-bottom: 1px solid rgba(239,68,68,.35);
      background:
        radial-gradient(1200px 120px at 50% 0%, rgba(239,68,68,.10), transparent 60%),
        #000;
      isolation:isolate;
    }
    .spacer::before,
    .spacer::after{
      content:"";
      position:absolute; inset:-2px;
      background:
        repeating-linear-gradient(135deg,
          rgba(239,68,68,.12) 0 10px,
          rgba(239,68,68,.06) 10px 20px,
          transparent 20px 30px,
          rgba(255,255,255,.04) 30px 40px);
      animation: slideDiag 10s linear infinite;
      mix-blend-mode:screen;
      opacity:.7;
    }
    .spacer::after{
      animation-direction: reverse;
      opacity:.4;
      filter: blur(2px);
    }
    @keyframes slideDiag {
      0%   { background-position: 0 0; }
      100% { background-position: 600px 300px; }
    }
    /* Stationary center accent line */
    .spacer .core{
      position:absolute; left:0; right:0; top:50%; height:2px; transform:translateY(-50%);
      background: linear-gradient(90deg, transparent, rgba(239,68,68,.9) 30%, rgba(255,255,255,.9) 50%, rgba(239,68,68,.9) 70%, transparent);
      box-shadow: 0 0 20px rgba(239,68,68,.35), 0 0 2px rgba(255,255,255,.25) inset;
      opacity:.9;
    }
    /* Endcaps that "pulse" horizontally to imply scroll */
    .spacer .dash {
      position:absolute; top:50%; width:120px; height:2px; transform:translateY(-50%);
      background: repeating-linear-gradient(90deg, rgba(255,255,255,.85) 0 12px, rgba(255,0,0,.85) 12px 24px, transparent 24px 36px);
      box-shadow: 0 0 10px rgba(239,68,68,.35);
      animation: dashPulse 3s ease-in-out infinite;
      opacity:.9;
    }
    .spacer .dash.left  { left: 2.5%;  transform:translateY(-50%) scaleX(.9); transform-origin:left; }
    .spacer .dash.right { right: 2.5%; transform:translateY(-50%) scaleX(.9); transform-origin:right; animation-delay:.8s; }
    @keyframes dashPulse {
      0%,100% { filter:brightness(1); transform:translateY(-50%) scaleX(.9); }
      50%     { filter:brightness(1.4); transform:translateY(-50%) scaleX(1.05); }
    }
    /* Label (optional): add data-label attr on spacer to show a small tag */
    .spacer[data-label]::marker { content:none; }
    .spacer[data-label]::before{
      content: attr(data-label);
      position:absolute; inset:auto auto calc(50% + 16px) 50%;
      transform: translateX(-50%);
      padding:.25rem .5rem; font-size:.65rem; letter-spacing:.08em;
      color:#fff; border:1px solid rgba(239,68,68,.5); border-radius:9999px;
      background:rgba(239,68,68,.15);
      text-transform:uppercase;
      box-shadow: 0 0 8px rgba(239,68,68,.3);
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .spacer::before, .spacer::after, .spacer .dash { animation: none !important; }
    }

    /* Cards */
    .card{border:2px solid #ef4444;border-radius:.75rem;padding:1rem;transition:all .3s ease;cursor:pointer;background:rgba(255,0,0,.05)}
    .card:hover{background:rgba(255,0,0,.12);transform:translateY(-1px)}
    .expanded{background:rgba(255,0,0,.2);box-shadow:0 0 0 1px #ef4444,0 10px 30px rgba(239,68,68,.15)}

    /* Subtle animated grid page backdrop */
    .bg-grid{
      background:
        radial-gradient(ellipse at 50% 20%, rgba(239,68,68,.10), transparent 50%),
        repeating-linear-gradient(0deg, rgba(239,68,68,.08) 0 1px, transparent 1px 24px),
        repeating-linear-gradient(90deg, rgba(239,68,68,.08) 0 1px, transparent 1px 24px),
        #000;
      animation:gridFloat 18s linear infinite;
    }
    @keyframes gridFloat{ 0%{background-position:0 0,0 0,0 0}100%{background-position:0 0,0 24px,24px 0} }

    /* Splash CRT shimmer */
    .scanlines:after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(to bottom, rgba(255,255,255,.05), rgba(0,0,0,0) 50%);
      mix-blend-mode:overlay; animation:scan 6s linear infinite; pointer-events:none;
    }
    @keyframes scan { 0%{transform:translateY(-100%)} 100%{transform:translateY(100%)} }

    /* ENTER button */
    .btn-enter{
      border:2px solid #ef4444;border-radius:9999px;padding:.9rem 1.5rem;
      font-weight:800;letter-spacing:.04em;
      background:linear-gradient(180deg, rgba(239,68,68,.15), rgba(239,68,68,.05));
      box-shadow:0 0 0 2px rgba(239,68,68,.25) inset, 0 8px 32px rgba(239,68,68,.2);
      transition:transform .15s ease, box-shadow .2s ease, background .2s ease;
    }
    .btn-enter:hover{transform:translateY(-1px);box-shadow:0 0 0 2px rgba(239,68,68,.35) inset, 0 12px 40px rgba(239,68,68,.28)}

    /* JSON wrap */
    pre.wrap-json{white-space:pre-wrap;word-wrap:break-word;overflow-x:auto}

    @media (max-width:420px){ .toolbar-tight{gap:.5rem} }
  </style>
</head>
<body class="bg-black text-white font-sans overflow-x-hidden bg-grid">

  <!-- Minimal Splash -->
  <section id="splash" class="section relative text-center scanlines">
    <div class="max-w-3xl px-6">
      <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight"><span class="text-red-500 drop-shadow">EOBots</span></h1>
      <p class="mt-4 text-lg text-white/80">Click ENTER to access free, open-source bots, tools, and guides.</p>
      <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-3">
        <a id="enterBtn" href="#home" class="btn-enter">ENTER EOBOTS →</a>
        <a href="#forum" class="rounded-full px-4 py-3 border border-white/20 hover:border-white/40 transition text-sm">Discord Mirror</a>
      </div>
      <p class="mt-6 text-xs text-white/60">Powered by Free &amp; Open Source • Players helping players</p>
    </div>
  </section>

  <!-- NAV -->
  <nav class="fixed top-0 left-0 w-full bg-black/80 border-b border-red-600 z-50 backdrop-blur" style="height:var(--nav-h)">
    <ul class="h-full flex items-center justify-center flex-wrap gap-4 px-4 text-lg">
      <li><a href="#home" class="hover:text-red-500">Home</a></li>
      <li><a href="#download" class="hover:text-red-500">Download</a></li>
      <li><a href="#howto" class="hover:text-red-500">How To</a></li>
      <li><a href="#forum" class="hover:text-red-500">Discord</a></li>
      <li><a href="#eor-api" class="hover:text-red-500">EOR DB</a></li>
      <li><a href="#eoguides" class="hover:text-red-500">EO Guides</a></li>
    </ul>
  </nav>

  <!-- Home -->
  <div class="spacer" data-label="Scroll"></div>
  <section id="home" class="section text-center px-6">
    <header class="mb-4">
      <h1 class="text-4xl font-bold text-red-500 mb-2">Welcome to EOBots</h1>
      <p class="text-sm opacity-80">Bots, tools, and clear setup guides—plus a community that actually helps.</p>
    </header>
    <div class="leading-snug max-w-xl mx-auto">
      <p class="text-base">
        As the player base has become mainly botters—and many are paying to bot—we’re offering
        <strong class="font-semibold">free, open-source</strong> botting resources. Some may be less “polished” than pay-to-win bots,
        but they’re free and open so everyone can catch up.
      </p>
      <div class="mt-3 flex flex-wrap justify-center gap-2">
        <span class="px-3 py-1 rounded-full border border-red-600/60 bg-white/5 text-xs"><strong>Free &amp; open-source</strong>: no paywalls</span>
        <span class="px-3 py-1 rounded-full border border-red-600/60 bg-white/5 text-xs"><strong>Community-driven</strong>: by players, for players</span>
        <span class="px-3 py-1 rounded-full border border-red-600/60 bg-white/5 text-xs"><strong>Practical over pretty</strong>: effective &amp; auditable</span>
      </div>
    </div>
    <footer class="mt-4 pt-3 border-t border-red-600/50 text-xs opacity-90 max-w-xl mx-auto">
      Explore downloads, learn the setups, and plug into the community.
    </footer>
  </section>

  <!-- Downloads -->
  <div class="spacer" data-label="Downloads"></div>
  <section id="download" class="section px-6">
    <h2 class="text-4xl font-bold text-red-500 mb-10">Downloads</h2>
    <div id="downloadsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-6xl"></div>
  </section>

  <!-- How To -->
  <div class="spacer" data-label="Guides"></div>
  <section id="howto" class="section px-6">
    <h2 class="text-4xl font-bold text-red-500 mb-10">How To Use</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-6xl mx-auto">
      <!-- Cards -->
      <div class="card group rounded-2xl border border-white/10 bg-black/40 p-4 shadow-lg hover:shadow-xl transition" onclick="toggleCard(this)">
        <h3 class="text-xl font-bold mb-1">Finding NPC Address</h3>
        <p class="text-white/80">Learn how to find NPC addresses.</p>
        <div class="card-body hidden mt-4 overflow-hidden rounded-xl">
          <div class="aspect-video w-full overflow-hidden rounded-xl">
            <iframe class="h-full w-full" loading="lazy"
              src="https://www.youtube.com/embed/iTLIuEHOfd4?si=ONAaS13zwQDKNSgP"
              title="YouTube video player" frameborder="0" allowfullscreen
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              referrerpolicy="strict-origin-when-cross-origin"></iframe>
          </div>
        </div>
      </div>

      <div class="card group rounded-2xl border border-white/10 bg-black/40 p-4 shadow-lg hover:shadow-xl transition" onclick="toggleCard(this)">
        <h3 class="text-xl font-bold mb-1">Configuring CaptchaBot</h3>
        <p class="text-white/80">Step-by-step setup tutorial.</p>
        <div class="card-body hidden mt-4 overflow-hidden rounded-xl">
          <div class="aspect-video w-full overflow-hidden rounded-xl">
            <iframe class="h-full w-full" loading="lazy"
              src="https://www.youtube.com/embed/ysz5S6PUM-U"
              title="YouTube video player" frameborder="0" allowfullscreen
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              referrerpolicy="strict-origin-when-cross-origin"></iframe>
          </div>
        </div>
      </div>

      <div class="card group rounded-2xl border border-white/10 bg-black/40 p-4 shadow-lg hover:shadow-xl transition" onclick="toggleCard(this)">
        <h3 class="text-xl font-bold mb-1">Recording Routes</h3>
        <p class="text-white/80">Guide to using the WalkPath Recorder.</p>
        <div class="card-body hidden mt-4 overflow-hidden rounded-xl">
          <div class="aspect-video w-full overflow-hidden rounded-xl">
            <iframe class="h-full w-full" loading="lazy"
              src="https://www.youtube.com/embed/eIP6LVxiPqw?si=iVTs-2GNDcT5j953"
              title="YouTube video player" frameborder="0" allowfullscreen
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              referrerpolicy="strict-origin-when-cross-origin"></iframe>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Discord -->
  <div class="spacer" data-label="Discord"></div>
  <section id="forum" class="section px-4">
    <h2 class="text-4xl font-bold text-red-500 mb-6">Community Discord</h2>
    <p class="mb-4 text-lg text-center max-w-2xl mx-auto">Talk with other EOBots users, share code, report bugs, and discuss updates below.</p>

    <div class="mx-auto w-full max-w-4xl">
      <div class="rounded-xl overflow-hidden shadow-2xl ring-1 ring-red-500/40 w-full"
           style="height:70svh; max-height:900px; min-height:420px;">
        <iframe
          data-src="https://discord.com/widget?id=1400941240404410499&theme=dark"
          class="w-full h-full block border-0 defer-embed"
          allowtransparency="true" frameborder="0"
          sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"
          title="Discord Widget" loading="lazy"></iframe>
      </div>

      <div class="mt-4 text-center">
        <a href="https://discord.gg/vuKJTzGt9K" target="_blank" rel="noopener"
           class="inline-block rounded-xl bg-[#5865F2] px-5 py-3 font-semibold text-white hover:opacity-90 transition">
          Join our Discord
        </a>
      </div>
    </div>
  </section>

  <!-- EOR DB -->
  <div class="spacer" data-label="EOR DB"></div>
  <section id="eor-api" class="section px-4 w-full">
    <h2 class="text-4xl font-bold text-red-500 mb-4 text-center">EOR Database Search</h2>

    <div class="mx-auto w-full max-w-5xl rounded-xl border border-red-500/40 bg-black/30 p-4">
      <div class="flex flex-col sm:flex-row sm:items-center toolbar-tight gap-2">
        <div class="flex flex-wrap gap-2">
          <button data-cat="items"  class="eor-tab rounded-md border border-red-500/40 px-3 py-1 text-white">Items</button>
          <button data-cat="npcs"   class="eor-tab rounded-md border border-red-500/40 px-3 py-1 text-white">NPCs</button>
          <button data-cat="spells" class="eor-tab rounded-md border border-red-500/40 px-3 py-1 text-white">Spells</button>
          <button data-cat="maps"   class="eor-tab rounded-md border border-red-500/40 px-3 py-1 text-white">Maps</button>
          <button data-cat="shops"  class="eor-tab rounded-md border border-red-500/40 px-3 py-1 text-white">Shops</button>
          <button data-cat="classes" class="eor-tab rounded-md border border-red-500/40 px-3 py-1 text-white">Classes</button>
          <button data-cat="quests" class="eor-tab rounded-md border border-red-500/40 px-3 py-1 text-white">Quests</button>
        </div>

        <div class="flex-1"></div>

        <label class="flex items-center gap-2 text-sm text-gray-300">
          <input id="eor-unk" type="checkbox" class="rounded border-red-500/40 bg-black/70">
          show_unk=1
        </label>

        <div class="relative w-full sm:w-80">
          <input id="eor-q" placeholder="Search name or ID…"
                 class="w-full rounded-md bg-black/70 border border-red-500/40 p-2 text-white pr-10">
          <span class="absolute right-2 top-2 text-gray-400">⌕</span>
        </div>
      </div>

      <div class="mt-4 grid gap-4 lg:grid-cols-2">
        <div>
          <div id="eor-status" class="text-sm text-gray-300 mb-2">Pick a category.</div>
          <ul id="eor-list" class="divide-y divide-red-500/20 rounded-md border border-red-500/30 bg-black/50 max-h-[55vh] overflow-auto"></ul>
          <button id="eor-more" class="mt-3 hidden rounded-md border border-red-500/40 px-3 py-1 text-white">Load more</button>
        </div>

        <div class="rounded-md border border-red-500/30 bg-black/50 p-3">
          <div class="flex items-center justify-between gap-2">
            <h3 id="eor-detail-title" class="text-xl font-semibold text-white">Details</h3>
            <div class="flex gap-2">
              <button id="eor-copy-json" class="rounded-md border border-red-500/40 px-2 py-1 text-xs text-white">Copy JSON</button>
              <button id="eor-copy-curl" class="rounded-md border border-red-500/40 px-2 py-1 text-xs text-white">Copy curl</button>
            </div>
          </div>
          <div id="eor-images" class="mt-3 flex flex-wrap gap-3 overflow-auto max-w-full"></div>
          <pre id="eor-detail" class="mt-3 max-h-[45vh] overflow-auto rounded bg-black/70 p-3 text-green-200 text-sm border border-red-500/20 wrap-json">Select a result…</pre>
        </div>
      </div>
    </div>
  </section>

  <!-- EO Guides -->
  <div class="spacer" data-label="EO Guides"></div>
  <section id="eoguides" class="section px-4">
    <h2 class="text-4xl font-bold text-red-500 mb-4 text-center">EO Guides</h2>

    <div class="mx-auto w-full max-w-6xl rounded-xl border border-red-500/40 bg-black/30 p-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
        <label class="text-sm text-gray-300">
          Page
          <select id="eog-select" class="w-full mt-1 rounded-md bg-black/70 border border-red-500/40 p-2 text-white">
            <option value="https://www.eo-guides.com/">Home</option>
            <option value="https://www.eo-guides.com/guides">Guides index</option>
            <option value="https://www.eo-guides.com/quests" selected>Quests</option>
            <option value="https://www.eo-guides.com/boss-encounters">Boss Encounters</option>
            <option value="https://www.eo-guides.com/classes">Classes</option>
            <option value="https://www.eo-guides.com/world-map">World Map</option>
            <option value="https://www.eo-guides.com/commands">Commands</option>
          </select>
        </label>

        <div class="flex-1"></div>

        <a href="https://www.eo-guides.com/" target="_blank" rel="noopener"
           class="inline-block rounded-md bg-red-600 px-4 py-2 text-white font-semibold hover:opacity-90">Open full site</a>
      </div>

      <div id="eog-wrap" class="relative mt-4 rounded-xl overflow-hidden shadow-2xl ring-1 ring-red-500/40"
           style="height:80svh; max-height:1000px; min-height:420px;">
        <iframe id="eog-frame"
          data-src="https://www.eo-guides.com/quests"
          class="absolute inset-0 w-full h-full border-0 defer-embed"
          loading="lazy" title="EO Guides"></iframe>
      </div>

      <div id="eog-fallback" class="hidden mt-3 rounded-md border border-red-500/30 bg-black/50 p-3 text-sm text-gray-300">
        Looks like this page can’t be embedded (X-Frame-Options). Use the “Open full site” button above.
      </div>
    </div>
  </section>

  <!-- Footer -->
  <div class="spacer" data-label="More Coming Soon"></div>
  <footer class="text-center py-6 border-t border-red-600 text-sm">
    © 2025 EOBots. Built by Cera &amp; Recovery — Featured Work By Empire, Trashman, Jetbot, and more.
  </footer>

  <!-- Scripts -->
  <script>
    // Splash remember
    (function(){
      const KEY="eobots.splash.seen";
      const splash=document.getElementById('splash');
      const enter=document.getElementById('enterBtn');
      if(localStorage.getItem(KEY)==="1"){ splash.style.display='none'; }
      enter.addEventListener('click',()=>{ localStorage.setItem(KEY,"1"); });
    })();

    // Toggle cards
    function toggleCard(cardEl){
      document.querySelectorAll('#howto .card').forEach(c=>{ if(c!==cardEl) collapseCard(c); });
      const body=cardEl.querySelector('.card-body'); if(!body)return;
      const open=body.classList.contains('hidden');
      if(open){ body.classList.remove('hidden'); cardEl.classList.add('expanded'); }
      else{ collapseCard(cardEl); }
    }
    function collapseCard(cardEl){
      const body=cardEl.querySelector('.card-body'); if(!body||body.classList.contains('hidden'))return;
      const iframe=body.querySelector('iframe'); if(iframe){ const s=iframe.src; iframe.src=s; }
      body.classList.add('hidden'); cardEl.classList.remove('expanded');
    }

    // Downloads loader
    async function loadDownloads(){
      const container=document.getElementById('downloadsContainer');
      try{
        const res=await fetch('downloads.json',{cache:'no-store'});
        if(!res.ok) throw new Error(res.statusText);
        const downloads=await res.json();
        if(!Array.isArray(downloads)) throw new Error('downloads.json must be an array');
        container.innerHTML='';
        downloads.forEach(d=>{
          const card=document.createElement('div');
          card.className='card';
          card.innerHTML=`
            <h3 class="text-xl font-bold mb-2">${d.title??'Untitled'}</h3>
            <p class="opacity-90">${d.description??''}</p>
            <div class="card-body hidden mt-4 text-sm">
              ${d.version?`<p><strong>Version:</strong> ${d.version}</p>`:''}
              ${d.details?`<p class="opacity-90">${d.details}</p>`:''}
              ${d.link?`<a href="${d.link}" target="_blank" class="text-red-400 underline mt-2 inline-block">Download</a>`:''}
            </div>`;
          card.onclick=()=>toggleCard(card);
          container.appendChild(card);
        });
      }catch{
        container.innerHTML='<p class="text-red-400">Error loading downloads.json</p>';
      }
    }
    loadDownloads();

    /* Lazy iframes (no layout change) + on-demand EOR */
    const lazyObserver = new IntersectionObserver((entries)=>{
      for(const e of entries){
        if(!e.isIntersecting) continue;
        e.target.querySelectorAll('iframe.defer-embed[data-src]').forEach(ifr=>{
          if(!ifr.src){
            ifr.src = ifr.getAttribute('data-src');
            ifr.removeAttribute('data-src');
          }
        });
        if(e.target.id==='eor-api' && !window.__EOR_INIT__){
          window.__EOR_INIT__ = true;
          initEOR();
        }
        lazyObserver.unobserve(e.target);
      }
    }, {root:null, rootMargin:'150px 0px', threshold:0.15});

    ['forum','eoguides','eor-api'].forEach(id=>{
      const sec=document.getElementById(id);
      if(sec) lazyObserver.observe(sec);
    });

    // EO Guides selector persistence
    (function(){
      const sel=document.getElementById("eog-select");
      const frame=document.getElementById("eog-frame");
      const fallback=document.getElementById("eog-fallback");
      const KEY="eog.last";
      const last=localStorage.getItem(KEY);
      if(last){ sel.value=last; frame.setAttribute('data-src', last); }
      sel.addEventListener("change",()=>{
        const url=sel.value; localStorage.setItem(KEY,url);
        if(!frame.src){ frame.setAttribute('data-src', url); } else { frame.src=url; }
      });
      frame.addEventListener("load",()=>{ try{
        const blocked = frame.contentDocument && frame.contentDocument.body && frame.contentDocument.body.childElementCount===0;
        if(blocked) fallback.classList.remove("hidden");
      }catch{} });
    })();

    /* EOR Search (init on demand) */
    function initEOR(){
      (()=>{
        const BASE="https://eor-api.exile-studios.com";
        const unk=document.getElementById("eor-unk");
        const q=document.getElementById("eor-q");
        const status=document.getElementById("eor-status");
        const listEl=document.getElementById("eor-list");
        const moreBtn=document.getElementById("eor-more");
        const detailEl=document.getElementById("eor-detail");
        const titleEl=document.getElementById("eor-detail-title");
        const imgWrap=document.getElementById("eor-images");
        const copyJsonBtn=document.getElementById("eor-copy-json");
        const copyCurlBtn=document.getElementById("eor-copy-curl");

        const tabs=[...document.querySelectorAll(".eor-tab")];
        let current="items";
        let cache={};
        let filtered=[];
        let page=0;
        const PAGE_SIZE=100;

        const catCfg={
          items:{list:"/api/items",detail:id=>`/api/items/${id}`,images:id=>[`/api/items/${id}/graphic`,`/api/items/${id}/graphic/ground`]},
          npcs:{list:"/api/npcs",detail:id=>`/api/npcs/${id}`,images:id=>[`/api/npcs/${id}/graphic`]},
          spells:{list:"/api/spells",detail:id=>`/api/spells/${id}`,images:id=>[`/api/spells/${id}/icon`,`/api/spells/${id}/graphic`]},
          maps:{list:"/api/maps",detail:id=>`/api/maps/${id}`,images:null},
          shops:{list:"/api/shops",detail:name=>`/api/shops/${encodeURIComponent(name)}`,images:null},
          classes:{list:"/api/classes",detail:id=>`/api/classes/${id}`,images:null},
          quests:{list:"/api/quests",detail:id=>`/api/quests/${id}`,images:null},
        };

        function qs(url){ return unk.checked ? url+(url.includes("?")?"&":"?")+"show_unk=1" : url; }

        async function fetchJson(path){
          const url=qs(BASE+path);
          const r=await fetch(url,{headers:{"Accept":"application/json"}});
          if(!r.ok) throw new Error(r.status+" "+r.statusText);
          return r.json();
        }

        function unwrapForList(cat,data){
          if(Array.isArray(data)) return data;
          if(data && typeof data==="object"){
            const keys=[cat,"data","results","list","records","items","npcs","spells","maps","classes","quests","shops"];
            for(const k of keys){ if(Array.isArray(data[k])) return data[k]; }
            const out=[];
            for(const [k,v] of Object.entries(data)){
              if(v==null) continue;
              if(typeof v==="string"||typeof v==="number"){ out.push({id:k,name:String(v),raw:v}); continue; }
              out.push({ id:v.id??v.itemId??v.npcId??v.spellId??v.classId??v.questId??v.mapId??k,
                         name:v.name??v.displayName??String(k),
                         raw:v });
            }
            return out;
          }
          return [];
        }

        function normalizeList(cat,list){
          return list.map((rec,idx)=>{
            if(typeof rec==="string") return {id:rec,name:rec,raw:rec};
            if(typeof rec==="number") return {id:rec,name:String(rec),raw:rec};
            const id = rec.id ?? rec.itemId ?? rec.npcId ?? rec.spellId ?? rec.classId ?? rec.questId ?? rec.mapId ?? rec.index ?? (cat==="shops"?rec.name:undefined) ?? idx;
            const name = rec.name ?? rec.displayName ?? ("#"+id);
            return {id,name,raw:rec};
          });
        }

        async function ensureList(cat){
          if(cache[cat]?.list) return;
          status.textContent=`Loading ${cat}…`;
          try{
            const raw=await fetchJson(catCfg[cat].list);
            const unwrapped=unwrapForList(cat,raw);
            const list=normalizeList(cat,unwrapped);
            cache[cat]={raw,list};
            status.textContent=`Loaded ${list.length} ${cat}.`;
          }catch(e){
            status.textContent=`Error loading ${cat}: ${e.message}`;
            cache[cat]={raw:[],list:[]};
          }
        }

        function applyFilter(){
          const needle=q.value.trim().toLowerCase();
          const list=cache[current].list||[];
          filtered = needle ? list.filter(r =>
            String(r.name).toLowerCase().includes(needle) ||
            String(r.id).toLowerCase().includes(needle)
          ) : list.slice();
          page=0; renderPage();
        }

        function renderPage(){
          listEl.innerHTML="";
          const start=page*PAGE_SIZE;
          const slice=filtered.slice(start,start+PAGE_SIZE);
          if(!slice.length){
            listEl.innerHTML=`<li class="p-3 text-gray-300">No results.</li>`;
            moreBtn.classList.add("hidden"); return;
          }
          const frag=document.createDocumentFragment();
          for(const r of slice){
            const li=document.createElement("li");
            li.className="p-2 hover:bg-black/40 cursor-pointer";
            li.innerHTML=`<div class="flex items-center justify-between gap-2">
              <div class="truncate text-white">${escapeHtml(r.name)}</div>
              <div class="text-xs text-gray-400">ID: ${escapeHtml(String(r.id))}</div>
            </div>`;
            li.addEventListener("click",()=>showDetail(r));
            frag.appendChild(li);
          }
          listEl.appendChild(frag);
          moreBtn.classList.toggle("hidden", start+PAGE_SIZE>=filtered.length);
        }

        function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

        async function showDetail(r){
          titleEl.textContent=`${capitalize(current)} – ${r.name}`;
          detailEl.textContent="Loading details…";
          imgWrap.innerHTML="";
          try{
            const key = (current==="shops") ? r.name : r.id;
            const path=catCfg[current].detail(key);
            const data=await fetchJson(path);
            detailEl.textContent=JSON.stringify(data,null,2);

            const imgs = catCfg[current].images ? catCfg[current].images(r.id) : [];
            if(imgs && imgs.length){
              for(const p of imgs){
                const url=qs(BASE+p);
                const img=document.createElement("img");
                img.src=url; img.alt=current+" image"; img.decoding="async";
                img.className="max-h-64 object-contain rounded border border-red-500/30 bg-black/70 p-2";
                imgWrap.appendChild(img);
              }
            }
            copyCurlBtn.onclick=()=>copy(`curl "${qs(BASE+path)}"`);
            copyJsonBtn.onclick=()=>copy(JSON.stringify(data,null,2));
          }catch(e){
            detailEl.textContent="Error: "+e.message;
            copyCurlBtn.onclick=null; copyJsonBtn.onclick=null;
          }
        }

        function copy(text){
          navigator.clipboard.writeText(text).then(()=>{
            copyJsonBtn.textContent="Copied"; copyCurlBtn.textContent="Copied";
            setTimeout(()=>{copyJsonBtn.textContent="Copy JSON";copyCurlBtn.textContent="Copy curl";},800);
          });
        }

        function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}

        function setActive(cat){
          current=cat;
          tabs.forEach(b=>b.classList.toggle("bg-red-600",b.dataset.cat===cat));
        }

        async function initCategory(cat){ setActive(cat); await ensureList(cat); applyFilter(); }

        tabs.forEach(b=>b.addEventListener("click",()=>initCategory(b.dataset.cat)));
        moreBtn.addEventListener("click",()=>{page++;renderPage();});
        let t=0; q.addEventListener("input",()=>{clearTimeout(t); t=setTimeout(applyFilter,150);});
        unk.addEventListener("change",()=>initCategory(current));

        initCategory(current);
      })();
    }
  </script>
</body>
</html>
